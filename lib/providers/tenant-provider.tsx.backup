
'use client'

import { createContext, useContext, useEffect, useState } from 'react'
import { useSupabase } from './supabase-provider'
import { EnhancedTenantContext, getClientTenantContext } from '@/lib/tenant-context'
import type { Database } from '@/lib/types/database'

type Tenant = Database['public']['Tables']['tenants']['Row']

// Legacy context for backward compatibility
type LegacyTenantContext = {
  tenant: Tenant | null
  loading: boolean
  switchTenant: (tenantId: string) => void
}

// Enhanced context
const EnhancedContext = createContext<EnhancedTenantContext | undefined>(undefined)
const Context = createContext<LegacyTenantContext | undefined>(undefined)

export default function TenantProvider({
  children,
}: {
  children: React.ReactNode
}) {
  const [tenant, setTenant] = useState<Tenant | null>(null)
  const [loading, setLoading] = useState(true)
  const { supabase, user } = useSupabase()

  const getTenantFromURL = () => {
    if (typeof window === 'undefined') return 'demo'
    
    const hostname = window.location.hostname
    const subdomain = hostname.split('.')[0]
    
    // For development
    if (hostname.includes('localhost') || hostname.includes('vercel.app')) {
      const urlParams = new URLSearchParams(window.location.search)
      return urlParams.get('tenant') || 'demo'
    }
    
    // For production with subdomains
    return subdomain !== 'www' ? subdomain : 'demo'
  }

  const fetchTenant = async (subdomain: string) => {
    try {
      const { data, error } = await supabase
        .from('tenants')
        .select('*')
        .eq('subdomain', subdomain)
        .single()

      if (error) {
        console.error('Error fetching tenant:', error)
        // Fallback to demo tenant
        const { data: fallback } = await supabase
          .from('tenants')
          .select('*')
          .eq('subdomain', 'demo')
          .single()
        setTenant(fallback)
      } else {
        setTenant(data)
      }
    } catch (error) {
      console.error('Error in fetchTenant:', error)
    } finally {
      setLoading(false)
    }
  }

  const switchTenant = (tenantId: string) => {
    const url = new URL(window.location.href)
    url.searchParams.set('tenant', tenantId)
    window.location.href = url.toString()
  }

  useEffect(() => {
    if (user) {
      const tenantSubdomain = getTenantFromURL()
      fetchTenant(tenantSubdomain)
    } else {
      setLoading(false)
    }
  }, [user, supabase])

  return (
    <Context.Provider value={{ tenant, loading, switchTenant }}>
      {children}
    </Context.Provider>
  )
}

export const useTenant = () => {
  const context = useContext(Context)
  if (context === undefined) {
    throw new Error('useTenant must be used inside TenantProvider')
  }
  return context
}

// Enhanced hook
export const useEnhancedTenant = () => {
  const context = useContext(EnhancedContext)
  if (context === undefined) {
    throw new Error("useEnhancedTenant must be used inside TenantProvider")
  }
  return context
}

// Main hook - returns enhanced context
export const useTenantContext = () => {
  const context = useContext(EnhancedContext)
  if (context === undefined) {
    throw new Error("useTenantContext must be used inside TenantProvider")  
  }
  return context
}
